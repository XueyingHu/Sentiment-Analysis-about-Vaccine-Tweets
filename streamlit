import streamlit as st
import boto3
import time

# AWS å®¢æˆ·ç«¯é…ç½®
client = boto3.client('bedrock', region_name='us-east-1')  # æ ¹æ®éœ€è¦æ›´æ”¹åŒºåŸŸ

# åˆå§‹åŒ–å¯¹è¯å†å²å’Œæˆæœ¬è®¡ç®—
if "chat_history" not in st.session_state:
    st.session_state["chat_history"] = []  # èŠå¤©å†å²è®°å½•
if "total_cost" not in st.session_state:
    st.session_state["total_cost"] = 0.0  # ç´¯è®¡æˆæœ¬
if "show_suggested" not in st.session_state:
    st.session_state["show_suggested"] = True  # æ§åˆ¶é¢„è®¾æç¤ºçš„æ˜¾ç¤º

# é¢„è®¾çš„ suggested prompt æŒ‰é’®åœ¨è¾“å…¥æ¡†ä¸Šæ–¹
suggested_prompts = ["Hello, how can I help you?", "Tell me a joke!", "What's the weather today?"]

def display_suggested_prompts():
    if st.session_state.show_suggested:
        st.write("### Suggested Prompts")
        cols = st.columns(len(suggested_prompts))
        for i, prompt in enumerate(suggested_prompts):
            if cols[i].button(prompt):
                st.session_state.input_text = prompt  # ç‚¹å‡»æ—¶å°†æç¤ºåŠ è½½åˆ°è¾“å…¥æ¡†

# å‘é€æ¶ˆæ¯è‡³AWS Bedrock
def send_message_to_bedrock(message):
    response = client.generate_text(
        prompt=message,
        max_tokens=100  # è®¾ç½®è¿”å›çš„tokenæ•°é‡ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´
    )
    # å¤„ç†è¿”å›ç»“æœå’Œæˆæœ¬è®¡ç®—ï¼ˆå‡è®¾æ¯ 1k tokens è®¡ä¸º 0.002 USDï¼‰
    response_text = response["generated_text"]
    tokens_used = response["usage"]["total_tokens"]
    cost = tokens_used * 0.002 / 1000
    return response_text, cost

# å¤„ç†èŠå¤©é€»è¾‘
def chat():
    display_suggested_prompts()  # æ˜¾ç¤ºé¢„è®¾æç¤º
    user_input = st.text_input("You:", key="input_text", on_change=send_user_message)
    if user_input:
        send_user_message()

# å‘é€ç”¨æˆ·æ¶ˆæ¯å¹¶æ›´æ–°å†å²è®°å½•
def send_user_message():
    user_message = st.session_state.input_text
    if user_message:
        # éšè—é¢„è®¾æç¤º
        st.session_state.show_suggested = False

        # æ˜¾ç¤ºç”¨æˆ·è¾“å…¥å¹¶ä¿å­˜è‡³å†å²
        st.session_state.chat_history.append({"role": "user", "content": user_message})
        
        # è°ƒç”¨ Bedrock API å¹¶è·å–å›å¤åŠæˆæœ¬
        response_text, cost = send_message_to_bedrock(user_message)
        
        # æ˜¾ç¤ºæ¨¡å‹å›å¤å¹¶ä¿å­˜è‡³å†å²
        st.session_state.chat_history.append({"role": "assistant", "content": response_text})
        
        # æ›´æ–°æ€»æˆæœ¬
        st.session_state.total_cost += cost

        # æ¸…ç©ºè¾“å…¥æ¡†
        st.session_state.input_text = ""

# æ˜¾ç¤ºèŠå¤©å†å²
def display_chat_history():
    for message in st.session_state.chat_history:
        role = "ğŸ¤– Assistant" if message["role"] == "assistant" else "ğŸ§‘ User"
        st.write(f"{role}: {message['content']}")

# æ˜¾ç¤ºå½“å‰å¯¹è¯æ€»æˆæœ¬
def display_cost():
    st.sidebar.write(f"Total Cost: ${st.session_state.total_cost:.4f}")

# ä¸»ç•Œé¢
st.title("Streamlit-based Chatbot with AWS Bedrock")
display_chat_history()  # æ˜¾ç¤ºèŠå¤©å†å²
chat()  # å¤„ç†èŠå¤©é€»è¾‘
display_cost()  # æ˜¾ç¤ºæˆæœ¬